---
title: "Midterm II"
author: "Fall 2018"
date: "Due: Wednesday, November 14, 2018" 
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(lubridate)
```  

##### 1. First write code that loads the workspace "Midterm II.RData". This should read five different tibbles into your workspace.  
```{r load workspace}
load("C:/Users/rdn3.BYU/Documents/GitHub/r4ds/Midterm II/Midterm II.RData")
```  

##### 2. Write code that recreates the tibbles "player" and "player_attributes" by importing the files "player.csv" and "player_attributes.csv". Compare the tibbles that you create with those in the Midterm II workspace to make sure that they are the same.  

##### 3. Write code that recreates the season factor variable in the player_attributes tibble. Season is defined as the year from the match_date variable. Make sure your code converts your variable into a factor.

```{r seasons factor}
seasons <- 2007:2016
player_attributes <- player_attributes %>% 
  mutate(season = year(match_date) %>% factor(levels = seasons))
```  

##### 4. We want to determine the total number of players that participate in any given season by using group_by, summarise, and geom_bar. Write code that creates the following bar chart:

```{r player in each season}
player_attributes %>% 
  group_by(player_id, season) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = season, fill = season)) +
    geom_bar(show.legend = FALSE) +
    labs(
      title = "Number of Players Participating in Each Year",
      subtitle = "2007 - 2016",
      x = "Season",
      y = "Number of Players"
    )
```  

##### 5. Explain the code in the script file that creates the following graph:

    
```{r}
# Number of seasons played
number_of_seasons <- player_attributes %>% 
  group_by(player_id, season) %>% 
  count() %>% 
  group_by(player_id) %>% 
  count()
colnames(number_of_seasons) <- c("player_id", "number_of_seasons")
number_of_seasons <- number_of_seasons %>% 
  mutate(number_of_seasons = factor(number_of_seasons, levels = 1:10))

number_of_seasons %>% 
  ggplot(aes(x = number_of_seasons, fill = number_of_seasons)) +
    geom_bar(show.legend = FALSE) +
    labs(
      title = "Longevity of Soccer Players",
      subtitle = "European Soccer Leagues",
      x = "Number of Seasons",
      y = "Number of Players"
    )
```  

##### 6. Write a function named age that will create a variable age for each player based on the birthday of the player and the day of the match.  

```{r age function}
### Function to calculate the age as of the player for each match
age <- function(birthday, match_date){
  (birthday %--% match_date) / years(1)
}
```  

##### 7. Interpret the code in the script file that creates the tibble player_attributes_complete.
  
```{r player_attributes_complete creation, warning = FALSE, message = FALSE}
player_attributes_complete <- player_attributes %>% 
  left_join(player, key = "player_id") %>% 
  mutate(age = age(birthday, match_date))
```  

##### 8. We are interested in the distribution of ages of the players that participated in the 2016 season. Recreate the player_attributes_2016 tibble and then write code that creates a violin plot for the ages of the players who participated in the 2016 season.

```{r}
# Violin plot of the ages of those that participated in 2016
player_attributes_2016 <- player_attributes_complete %>% 
  filter(year(match_date) == 2016)

player_attributes_2016 %>% 
  ggplot(aes(x = factor(0), y = age)) +
    geom_violin(fill = "lightblue") +
    geom_boxplot(width = 0.25, fill = "lightgreen") +
    coord_flip() +
    labs(
      title = "Age Distribution of Soccer Players",
      subtitle = "2016 Season",
      x = "",
      y = "Years"
    )
```  

##### 9. Explain the code in the script file that creates the following graph:
    
```{r age and average rating, warning = FALSE, message = FALSE}

# Relationship of Age and Average Rating for 2016 players
player_attributes_2016 %>% 
  group_by(player_id) %>% 
  summarize(
    average_rating = mean(rating)
  ) %>% 
  left_join(player, key = "player_id") %>% 
  mutate(age = age(birthday, ymd(20160701))) %>% 
  ggplot(aes(x = age, y = average_rating)) +
    geom_point(position = "jitter", alpha = 1/5, shape = 19, color = "red") +
    geom_smooth() +
    labs(
      title = "Relationship of Player Rating and Age",
      subtitle = "2016 Soccer Year or European Soccer League",
      x = "Years",
      y = "Average Rating"
    )
```   

##### 10. Interpret the following code in the script file that compares the time series for average age and average rating.  
    
```{r time series}
# Time series of average age and average rating
player_attributes_complete %>% 
  group_by(season) %>% 
  summarize(
    Age = mean(age),
    Rating = mean(rating, na.rm = TRUE)
  ) %>% 
  gather(Age, Rating, key = "measure", value = "amount")  %>% 
  ggplot(aes(y = amount, color = measure)) +
    geom_point(aes(x = season), show.legend = FALSE) +
    geom_path(aes(x = as.numeric(season)), show.legend = FALSE) +
    facet_grid(rows = vars(measure), scales = "free_y") +
    labs(
      title = "Trends in Average Age and Average Rating",
      subtitle = "European Soccer League (Kaggle Dataset",
      x = "",
      y = ""
    )
```  