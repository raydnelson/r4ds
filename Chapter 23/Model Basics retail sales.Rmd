---
title: "Model Basics: Retail Sales"
author: "MPA 634: Data Science for Managers"
date: "20 November 2019"
output: 
  html_document:
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
# Load libraries
library(tidyverse)
library(forecast)
library(fImport)
library(timeSeries)
library(car)
library(magrittr)
```  

This R Markdown document requires the forecast, fImport, timeSeries, magrittr, and car libraries. For this reason, you may need to install them in order for you to be able to execute the code. 

## Modeling and forecasting steps using an exploratory approach

1. Become familiar with the data using graphs
1. Identify families of models that might be appropriate
1. Estimate the models
1. Check the residuals to see if information remains
1. Use the model to make forecasts

## Example: Forecast of not seasonally adjusted retail sales

### Obtain the data from FRED

```{r get retail from FRED}
retail <- fredSeries('RSAFSNA', from = "1992-01-01") %>%
  as.ts() %>% 
  divide_by(1000)
```

### Draw a picture of the data  

```{r preliminary evaluation}
retail %>% 
  ggtsdisplay()
```  

### Remove the trend
```{r remove the trend}
retail %>% 
  diff(lag = 1) %>% 
  ggtsdisplay()
```

### Remove the trend and seasonality
```{r remove the trend and seasonality}
retail %>% 
  diff(lag = 1) %>% 
  diff(lag = 12) %>% 
  ggtsdisplay()
```

### Possible model families

1. Season and Trend with Loess (STL)
2. Exponetial smoothing or state space modeling
3. Auto-regressive Integrated Moving Average (ARIMA)

### Use the additive decomposition model to separate the time series into:

*  Trend\Cycle
*  Seasonality
*  Remainder  

```{r stl decomposition}
retail_stl <- retail %>% 
  stl(s.window = 7)
retail_stl %>%
  str()
```

#### Result of the decomposition  

```{r stl components}
retail_stl %>% 
  autoplot() +
  labs(
    title = "STL decomposition of time series"
  )
```

#### Information in STL residuals?

```{r stl residuals}
retail_stl$time.series[, "remainder"] %>% 
  ggtsdisplay()
```

#### Prediction using the STL model

```{r stl prediction}
retail_stl %>%
  forecast(h = 24) %>% 
  autoplot()
```

### ETS is part of the family of state space models. These models are also known as exponential smoothing.  

```{r estimate an ets model}
retail_ets <- retail %>%
  ets(model = "ZZZ")
retail_ets %>% str()
retail_ets %>% summary()
retail_ets %>%
  residuals() %>% 
  tail(24)
retail_ets %>%
  fitted() %>% 
  tail(24)
```  

#### ETS doesn't extract all of the information from the data. Information remains in the residuals  

```{r information in ets residuals}
retail_ets %>% 
  residuals() %>% 
  ggtsdisplay()
```

#### Forecasting with the ETS model

```{r ets forecasts}
retail_ets %>% 
  forecast(h = 24) %>% 
  autoplot()
```

### ARIMA model

#### Human diagnosis

```{r human ARIMA model}
retail_human <- retail %>% 
  arima(order = c(2, 1, 1), seasonal = c(0, 1, 0))
retail_human %>% 
  checkresiduals()
forecast(retail_human, h = 24) %>%
  as.ts() %>% 
  autoplot()
```

### Machine learning

```{r machine learning}
retail_machine <- retail %>% 
  auto.arima()
retail_machine %>% 
  checkresiduals()
retail_machine %>% 
  forecast(h = 24) %>% 
  autoplot()
```