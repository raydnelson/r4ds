---
title: "Dates and Times"
author: "MPA 634: Data Science for Managers"
date: "2 March 2020"
output:
  html_document:
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load libraries
library(tidyverse)
library(conflicted)
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
library(lubridate)
library(nycflights13)
library(knitr)
library(kableExtra)
```  

## Creat the tibble that has converted departure and arrival times.

```{r construct data-times out of numbers}
make_datetime_100 <- function(year, month, day, time){
  make_datetime(year, month, day, time %/% 100, time %% 100)
}

flights_dt <- flights %>%
  filter(!is.na(dep_time), !is.na(arr_time)) %>% 
  mutate(
    dep_time = make_datetime_100(year, month, day, dep_time),
    arr_time = make_datetime_100(year, month, day, arr_time),
    sched_dep_time = make_datetime_100(year, month, day, sched_dep_time),
    sched_arr_time = make_datetime_100(year, month, day, sched_arr_time)
  ) %>% 
  select(origin, dest, ends_with("delay"), ends_with("time"))

flights_dt %>% print()
```

## 16.4 Time Spans  

*  Durations
*  Periods
*  Intervals 

### 16.4.1 Durations are always recorded in seconds  

### How old is Hadley?  

```{r Hadley age}
(h_age <- today() - ymd(19791014))
as.duration(h_age)
```  

### Convenient constructors  

```{r constructors}
dseconds(15)
dminutes(10)
dhours(c(12, 24))
ddays(0:5)
dweeks(3)
dyears(1)
```

You can add and multiply durations.    

```{r add and multiply}
2 * dyears(1)
dyears(1) + dweeks(12) + dhours(15)
```

You can add and subtract durations  

```{r add and subtract}
(tomorrow <- today() + ddays(1))
(last_year <- today() - dyears(1))
```

Be care of time zones  

```{r time zones}
(one_pm <- ymd_hms("2016-3-12 13:00:00", tz = "America/New_York"))

one_pm + ddays(1)
```

16.4.2 Periods (Human Time)  

Constructor functions  

```{r period constructor functions}
seconds(15)
minutes(10)
hours(c(12, 24))
days(7)
months(1:6)
weeks(3)
years(1)
```

```{r as expected}
ymd(20160101) + dyears(1)
ymd(20160101) + years(1)

one_pm + ddays(1)
one_pm + days(1)
```

### Problem with overnight flights  

```{r overnight flights}
flights_dt %>% 
  filter(arr_time < dep_time)
```

### Fix the arrival day problem  

```{r fix arrival date}
flights_dt <- flights_dt %>%
  mutate(
    overnight = arr_time < dep_time,
    arr_time = arr_time + days(overnight * 1),
    sched_arr_time = sched_arr_time + days(overnight * 1)
  )

flights_dt %>% 
  filter(overnight, arr_time < dep_time)
```  

## 16.4.3 Intervals  

```{r intervals, message = FALSE}
years(1) / days(1)
(next_year <- today() + years(1))
(today() %--% next_year) %/% ddays(1)
(today() %--% next_year) %/% days(1)
```