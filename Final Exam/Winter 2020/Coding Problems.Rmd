---
title: "Final Exam Winter 2020"
author: "Data Science for Managers"
date: "Due by midnight: 22 April 2020"
output:
  html_document:
    code_folding: hide
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
library(tidyverse)
library(nycflights13)
```

Submit an R Markdown file for the following five problems. In order to get full credit, your R Markdown document must knit properly and you shouldn't use any software other than R to complete your calculations.    

## Problem 1 Violin Plot

Create the following violin plot for the hwy and cty variables from the mpg tibble.

* Include the mean as part of your violin plot
* Use the Pastel1 brewer palette
* Carefully label the graph so that yours matches the violin plot shown.

```{r Problem 1}
mpg %>%
  select(hwy, cty) %>%
  pivot_longer(cols = c(hwy, cty),
               names_to = "Type_of_Driving",
               values_to = "Miles_Per_Gallon") %>%
  ggplot(aes(x = Miles_Per_Gallon,
             y = Type_of_Driving,
             fill = Type_of_Driving)) +
  geom_violin(show.legend = FALSE) +
  geom_boxplot(fill = "grey",
               width = 0.10,
               show.legend = FALSE) +
  stat_summary(
    fun = "mean",
    geom = "point",
    shape = 23,
    size = 1.5,
    fill = "white"
  ) +
  scale_fill_brewer(palette = "Pastel1") +
  labs(
    title = "Highway driving has higher mileage but more variation.",
    subtitle = "Only models with new releases between 1999 and 2008.",
    x = "Miles Per Gallon",
    y = "Type of Driving",
    caption = "Source: MPG tibble from the tidyverse library."
  )
```

## Problem 2 top 5 destinations

* Calculate the number of flights leaving from JFK for each destination airport.
* Sort the destinations in descending order and choose the top 5 destinations.
* Save the tibble so that it can be used in the next problem.
* Print the top five airports.

```{r Problem 2}
(top_five <- flights %>% 
  filter(origin == "JFK") %>% 
  group_by(dest) %>% 
  count(dest) %>% 
  arrange(desc(n)) %>% 
  head(5)
)
```

## Problem 3 Bar chart with filtering

* Use the tibble from Problem 2 and a filtering join to select only those rows from the flights tibble that fly to the top five destinations. If you haven't been able to complete Problem 2 successfully, then email me and I will send you the tibble you need to complete this problem.
* Choose only those flights that leave from JFK.
* Create a horizontal Pareto chart with the largest frequency (LAX) at the top of the graph.
* Use the Pastel2 brewer palette.
* Optionally, if you are looking for an additional challenge, you could also use a mutating join to add the airport names to your graph rather than the codes (LAX is Los Angeles).

```{r Problem 3}
flights %>% 
  semi_join(top_five) %>%
  filter(origin == "JFK") %>% 
  ggplot(aes(y = fct_infreq(dest) %>% fct_rev(), fill = dest)) +
  geom_bar(show.legend = FALSE) + 
  scale_fill_brewer(palette = "Pastel2") +
  labs(
    title = "Most flights leaving JFK in New York fly to LA.",
    x = "Number of Flights",
    y = "Destination"
  )
```

## Problem 4 

Write a function that identifies the size of the most deviant observations in a numerical vector as defined by the largest absolute value of the z-score.

* Calculate the deviation from the mean.
* Calculate the z-score by dividing each deviation by the standard deviation.
* Calculate the absolute value of each z-score.
* Find the largest absolute z-score and round the result to two decimal places.
* Test your function on the hwy column from the mpg tibble.
* Optional: Show that you can accomplish the same thing with one line of code in the body by using the **scale()** function.

```{r Problem 4}
most_deviant <- function(x) {
  deviation <- x - mean(x)
  z_score <- deviation / sd(x)
  z_score %>% abs() %>% max() %>% round(2)
}
```
The z-score for the most deviant observation in the hwy column in the mpg tibble is: ```r most_deviant(mpg$hwy)```

```{r Problem 4 one line body}
most_deviant_efficient <- function(x) {
  scale(x) %>% abs() %>% max() %>% round(2)
}
```

The z-score for the most deviant observation in the hwy column in the mpg tibble that is found by using the scale function is: ```r most_deviant_efficient(mpg$hwy)```



## Problem 5 Loops and mapping functions

1. Demonstrate how to use glimpse to find that the numerical variables in mpg are cyl, displ, cty, and hwy.
1. Create a new tibble that includes only the numerical columns from mpg.
1.  Use a for loop and your function from problem 4 to find the most deviant absolute z-score for each numerical column in the mpg tibble. If you have struggled with the function in Problem 4, email me and I will send you the answer.
1.  Use a map function to accomplish the same thing as the previous step.
1.  Print out your z-scores from your loop and from using map.

```{r Problem 5}
mpg %>% glimpse()

mpg_numeric <- mpg %>% 
  select(displ, cty, hwy, cyl)

deviant_values <- vector("numeric", length(mpg_numeric))
for (i in seq_along(mpg_numeric)) {
  deviant_values[[i]] <- mpg_numeric[[i]] %>% most_deviant()
}

from_map <- mpg_numeric %>% 
  map_dbl(most_deviant)
```

The largest absolute z-scores found using a loop are:

```{r from loop}
deviant_values
```

The largest absolute z-scores found using map are:

```{r from map}
from_map
```

## Optional if you want another challenge, arrange the loop and map results into a single tibble.

* Use column names from from your tibble of numerical variables.
* Get the values for the second column from the results of your loop.
* Get the values for the third column from the results of your map.
* Print out the resulting tibble.

```{r results tibble}
results <- tibble(Variables = colnames(mpg_numeric), From_Loop = deviant_values, From_Map = from_map)
results
```

