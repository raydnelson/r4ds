---
title: "Graphics for Communication"
author: "MPA 634: Data Science for Managers"
date: "4 December 2019"
output: 
  html_document:
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
# Load libraries
library(tidyverse)
library(ggrepel)
library(viridis)
library(gridExtra)
library(RColorBrewer)
```  

## 28.2 Labels

```{r putting labels on graphs}
mpg %>% ggplot(aes(displ, hwy)) +
  geom_point(aes(color = class), position = "jitter") +
  geom_smooth(se = FALSE) +
  labs(
    title = "Fuel efficiency generally decreases with engine size",
    subtitle = "Two seaters (sports cars) are an exception because of their light weight",
    caption = "Data from fueleconomy.gov",
    x = "Engine displacement (L)",
    y = "Highway fuel economy (mpg)",
    color = "Car type"
  )
```  

## 28.3 Annotations

### Create tibble that has the name of the best in class

```{r identification of best cars in class}
## Best MPG in each car class
(best_in_class <- mpg %>%
  group_by(class) %>%
  filter(row_number(desc(hwy)) == 1)
)
```

### Scatterplot using geom_text

```{r geom_text}
mpg %>%
  ggplot(aes(displ, hwy)) +
  geom_point(aes(colour = class), position = "jitter") +
  geom_text(data = best_in_class, aes(label = model))
```

### Scatterplot using geom_label
```{r geom_label}
mpg %>%
  ggplot(aes(displ, hwy)) +
  geom_point(aes(colour = class), position = "jitter") +
  geom_label(data = best_in_class,
             aes(label = model),
             nudge_y = 2,
             alpha = 0.5)
```

### Scatterplot using geom_label_repel

```{r geom_label_repel}
mpg %>%
  ggplot(aes(displ, hwy)) +
  geom_point(aes(colour = class), position = "jitter") +
  geom_point(size = 3, shape = 1, data = best_in_class) +
  ggrepel::geom_label_repel(aes(label = model), data = best_in_class)
```

### Create a tibble of medians for displacement and highway mpg

```{r medians}
(class_avg <- mpg %>%
  group_by(class) %>%
  summarise(
    displ = median(displ),
    hwy = median(hwy)
  )
)
```

### Place the labels at the medians of displ and hwy

```{r labels at the medians}
mpg %>%
  ggplot(aes(displ, hwy, colour = class)) +
  ggrepel::geom_label_repel(
    data = class_avg,
    aes(label = class),
    size = 6,
    label.size = 0,
    segment.color = NA
  ) +
  geom_point(position = "jitter") +
  theme(legend.position = "none")
```

### Placement of text in upper right corner

```{r placement of text in upper right}
(label <- mpg %>%
  summarise(displ = max(displ),
            hwy = max(hwy),
            label = "Increasing engine size is \nrelated to decreasing fuel economy.")
)

ggplot(mpg, aes(displ, hwy)) +
  geom_point(position = "jitter") +
  geom_text(data = label,
            aes(label = label),
            vjust = "top",
            hjust = "right")
```

### Placement of text in extreme upper right corner

```{r placement of text at extreme upper right}
label <- tibble(displ = Inf,
                hwy = Inf,
                label = "Increasing engine size is \nrelated to decreasing fuel economy.")

ggplot(mpg, aes(displ, hwy)) +
  geom_point(position = "jitter") +
  geom_text(data = label,
            aes(label = label),
            vjust = "top",
            hjust = "right")
```

## 28.4.1 Axis ticks and legend keys

### Change the breaks in the y-axis

```{r control breaks on the y axis}
ggplot(mpg, aes(displ, hwy)) +
  geom_point() +
  scale_y_continuous(breaks = seq(15, 40, by = 5))
```

### Time line of presidential terms

```{r presidential}
presidential %>%
  mutate(id = 33 + row_number()) %>%
  ggplot(aes(start, id, color = party)) +
    geom_point(size = 4) +
    geom_segment(aes(xend = end, yend = id), size = 3) +
    scale_x_date(breaks = presidential$start, date_labels = "'%y") +
    scale_y_continuous(breaks = seq(34, 44, 1), labels = presidential$name) +
    labs(
      title = "The political party of the elected US president regularly changes.",
      x = "",
      y = "",
      color = "Political Party"
    ) +
    theme(panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          legend.position = "bottom") +
    scale_colour_manual(values = c("Republican" = "red", "Democratic" = "blue"))
```  

## 28.4.2 Legend Layout

## Changing the numerical scale

```{r log transformation of diamond weight and price}
diamonds %>% 
  ggplot(aes(carat, price)) +
  geom_hex()

diamonds %>% 
  ggplot(aes(log10(carat), log10(price))) +
  geom_hex()

diamonds %>% 
  ggplot(aes(carat, price)) +
  geom_hex() +
  scale_x_log10() +
  scale_y_log10()
```

## Changing the color scale

```{r changes in the color scale}
mpg %>%
  ggplot(aes(displ, hwy)) +
  geom_point(aes(color = drv), position = "jitter")

mpg %>%
  ggplot(aes(displ, hwy)) +
  geom_point(aes(color = drv), position = "jitter") +
  scale_colour_brewer(palette = "Set1")

mpg %>%
  ggplot(aes(displ, hwy)) +
  geom_point(aes(color = drv, shape = drv), position = "jitter") +
  scale_colour_brewer(palette = "Set1")
```

### Color scaling using the viridis package

```{r}
df <- tibble(
  x = rnorm(10000),
  y = rnorm(10000)
)

regular_plot <- df %>%
  ggplot(aes(x, y)) +
  geom_hex() +
  coord_fixed()

viridis_plot <- df %>%
  ggplot(aes(x, y)) +
  geom_hex() +
  viridis::scale_fill_viridis() +
  coord_fixed()

grid.arrange(regular_plot, viridis_plot, nrow = 1)
```

### Zooming  

There are three ways to control the plot limits:

1.  Adjust what data is plotted
2.  Set the limits in each scale
3.  Set xlim and ylim in coord_caartesian()  


```{r use filtering, message = FALSE}
# Original plot
original <- mpg %>% 
  ggplot(aes(displ, hwy)) +
  geom_point(aes(color = class)) +
  geom_smooth()

filtered <- mpg %>% 
  filter(displ >= 5, displ <= 7, hwy >= 10, hwy <= 30) %>% 
  ggplot(aes(displ, hwy)) +
  geom_point(aes(color = class)) +
  geom_smooth()
  
axis_scaled <- ggplot(mpg, mapping = aes(displ, hwy)) +
  geom_point(aes(color = class)) +
  geom_smooth() +
  coord_cartesian(xlim = c(5, 7), ylim = c(10, 30))

grid.arrange(original, filtered, axis_scaled, nrow = 3)
```

### Share common scales  

```{r scaling problem}
suv <- mpg %>% 
  filter(class == "suv")
compact <- mpg %>% 
  filter(class == "compact")

suv_plot <- suv %>% 
  ggplot(aes(displ, hwy, colour = drv)) +
  geom_point()

compact_plot <- compact %>% 
  ggplot(aes(displ, hwy, color = drv)) +
  geom_point()

grid.arrange(suv_plot, compact_plot, nrow = 1)
```

### Solution to the scaling problem

```{r scaling solution}
x_scale <- scale_x_continuous(limits = range(mpg$displ))
y_scale <- scale_y_continuous(limits = range(mpg$hwy))
col_scale <- scale_colour_discrete(limits = unique(mpg$drv))

suv_plot <- suv %>%
  ggplot(aes(displ, hwy, color = drv)) +
  geom_point() +
  x_scale +
  y_scale +
  col_scale

compact_plot <- compact %>%
  ggplot(aes(displ, hwy, color = drv)) +
  geom_point() +
  x_scale +
  y_scale +
  col_scale

grid.arrange(suv_plot, compact_plot, nrow = 1)
```

### Themes

```{r themes, message = FALSE}
mpg %>% 
  ggplot(aes(displ, hwy)) +
  geom_point(aes(color = class)) +
  geom_smooth(se = FALSE) +
  theme_minimal()
```










