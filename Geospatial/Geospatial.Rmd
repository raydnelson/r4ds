---
title: "Geospatial Visualization"
author: 'MPA 634: Data Science'
date: "1 April 2021"
output:
  html_document:
    code_folding: hide
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
library(tidyverse)
library(leaflet)
library(colorspace)
library(sf)
load(url("http://govfinance.byu.edu/govfinance/classes/dataViz/lectures/workspaces/geospatial I.RData"))
```

### Maps using ggplot

#### Map outlines

In order to draw maps, we need boundaries that are expressed as polygons. We can get map boundaries from the maps library.

```{r map outlines}
world <- st_as_sf(maps::map('world', plot = FALSE, fill = TRUE))
us <- st_as_sf(maps::map('state', plot = FALSE, fill = TRUE))
utah <- st_as_sf(maps::map('county', 'utah', plot = FALSE, fill = TRUE))
```

#### World map

```{r world}
world %>% class()
world %>% 
  ggplot(aes(fill = ID)) +
  geom_sf(alpha = 0.5, show.legend = FALSE) +
  scale_fill_discrete_qualitative(palette = "Dynamic")
  
```

#### United States

```{r US}
us %>% 
  ggplot(aes(fill = ID)) +
  geom_sf(alpha = 0.5, show.legend = FALSE) +
  scale_fill_discrete_qualitative(palette = "cold")
```

#### Utah

```{r Utah}
utah %>% 
  ggplot(aes(fill = ID)) +
  geom_sf(show.legend = FALSE) +
  scale_fill_viridis_d()
```

#### North Carolina with counties colored by area

```{r map of North Carolina}
nc %>% 
  ggplot(aes(fill = AREA)) + 
  geom_sf() +
  scale_fill_viridis_c()
```

### Leaflet

The leaflet library is a specialized mapping library

Main parts of map created by leaflet

-   data
-   tiles
-   markers

#### Tanner Building

```{r Tanner Building}
(TNRB <- leaflet() %>% 
    addTiles() %>% 
    addMarkers(lat = 40.2504,
               lng = -111.6525,
               popup = "Marriott School of Business")
)
```

#### Function to draw map and location

```{r map location function}
map_location <- function(lat, lng, popup) {
  leaflet() %>% 
    addTiles() %>% 
    addMarkers(lat = lat,
               lng = lng,
               popup = popup)
}
```

#### Map of the Nelsons Home

Coordinates for Nelson Home

-   Latitude: 40.268831
-   longitude: -111.644243

You can get the coordinates of an address from google maps. On your phone, touch and hold the location. On your computer, find the location, then right click on the coordinates and they will be copied to the clipboard.

```{r Mookis hideout}
map_location(lat = 40.268831,
             lng = -111.644243,
             popup = "Nelsons")
```

#### Change the map

[Possible maps](http://leaflet-extras.github.io/leaflet-providers/preview/index.html)

```{r alternative map tiles}
TNRB %>% 
  addProviderTiles(provider = providers$MtbMap,
                   options = providerTileOptions(opacity = 0.1))
TNRB %>% 
  addProviderTiles(provider = providers$Stamen.Toner)

TNRB %>% 
  addProviderTiles(provider = providers$CartoDB.Positron)
```

#### Use map overlays to create layers

```{r stack map layers}
TNRB %>%
  addProviderTiles(provider = providers$MtbMap,
                   options = providerTileOptions(opacity = 0.5)) %>%
  addProviderTiles(provider = providers$Stamen.TonerLines,
                   options = providerTileOptions(opacity = 0.5)) %>%
  addProviderTiles(provider = providers$Stamen.TonerLabels)
```

### Class activity

-   Use Google maps to find the coordinates for the Salt Lake City Temple
-   Use Leaflet and the CartoDB.Positron provider to draw the map
-   Locate and label the temple

```{r Salt Lake City Temple}
map_location(lat = 40.77066,
             lng = -111.891987,
             popup = "Salt Lake City Temple")
```

### Examples

#### Map of United States

```{r  US map using leaflet}
us %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons(fillColor = topo.colors(10, alpha = NULL), stroke = FALSE)
```

#### Weather Map

```{r weather map}
leaflet() %>%
  addTiles() %>%
  setView(-93.65, 42.0285, zoom = 4) %>%
  addWMSTiles(
    "http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi",
    layers = "nexrad-n0r-900913",
    options = WMSTileOptions(format = "image/png", transparent = TRUE),
    attribution = "Weather data Â© 2012 IEM Nexrad"
  )
```

#### Map of earthquakes

##### Basic Map

```{r earthquakes}
quakes %>% 
  slice_head(n = 20) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addMarkers(popup = ~as.character(mag),
             label = ~as.character(mag))
```

##### Customize markers

```{r customize markers}
quakes %>% 
  slice_head(n = 20) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(
    radius = 5,
    color = "red",
    stroke = FALSE,
    fillOpacity = 0.5
  )
```

##### Need to cluster

```{r need to cluster}
quakes %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(
    radius = 3,
    color = "red",
    stroke = FALSE,
    fillOpacity = 1 / 10
  )
```

##### Clusters of earthquakes

```{r clusters of earthquakes}
quakes %>% 
  leaflet() %>% 
  addTiles() %>%
  addMarkers(
    
  clusterOptions = markerClusterOptions(),
  
)
```

#### NYC airbnb

```{r read NYC airbnb data}
set.seed(1234)
NYC <- read_csv("C:/Users/rdn3/Documents/GitHub/dataviz/Wilke/Chapter15/NYC AirBnB.csv") %>% 
  slice_sample(n = 1000)
```

##### Simple Map

```{r simple NYC Map}
NYC %>% 
  leaflet() %>% 
  addTiles() %>% 
  addMarkers()
```

##### Explore Map

```{r explore NYC AirBnB properties}
NYC %>%
  leaflet() %>%
  addProviderTiles(provider = providers$CartoDB.Positron) %>%
  addCircleMarkers(
    popup = ~ price,
    label = ~ price,
    radius = 5,
    color = "red",
    stroke = FALSE,
    fillOpacity = 1 / 10
  )
```

#### COVID-19 Vectors

```{r covid-19}
covid %>% 
  leaflet() %>% 
  addProviderTiles(provider = providers$Esri.WorldImagery) %>%
  addCircleMarkers(
    radius = 5,
    color = "red",
    stroke = FALSE,
    fillOpacity = 0.2
  )
```

### Choropleth using leaflet

#### Basic map

```{r basic choropleth}
(m <- states %>% 
  leaflet() %>% 
  setView(-96, 37.8, 4) %>% 
  addTiles()
)
```

#### Add polygons for each state

```{r choropleth with states}
m %>% 
  addPolygons()
```

#### Calculations for adding color to states

```{r color calculations}
bins <- c(0, 10, 20, 50, 100, 200, 500, 1000, Inf)
pal <- colorBin("YlOrRd", domain = states$density, bins = bins)
```

#### Customize the polygons

```{r customize polygons}
m %>% addPolygons(
  fillColor = ~pal(density),
  weight = 2,
  opacity = 1,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.7)
```

#### Construct the labels

```{r label construction}
labels <- sprintf(
  "<strong>%s</strong><br/>%g people / mi<sup>2</sup>",
  states$name, states$density
) %>%
  lapply(htmltools::HTML)
```

#### Add highlighting

```{r choropleth with highlights}
m %>%
  addPolygons(
    fillColor = ~ pal(density),
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE
    ),
    label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    )
  ) %>%
  addLegend(
    pal = pal,
    values = ~ density,
    opacity = 0.7,
    title = NULL,
    position = "bottomright"
  )
```

### 
