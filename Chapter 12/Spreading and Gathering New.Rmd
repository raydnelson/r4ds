---
title: "Gathering, Spreading, Separating, and Uniting"
author: "Ray Nelson"
date: "20 Feb 2019"
output:
  html_document:
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load libraries
library(tidyverse)
library(fImport)
library(zoo)
```

## Import the Data 

```{r alternative structures}
# Load workspace
fitness <- read_csv(url("http://govfinance.byu.edu/govfinance/classes/dataScience/lectures/illustrations/Fitness.csv"))
movies <- read_csv(url("http://govfinance.byu.edu/govfinance/classes/dataScience/lectures/illustrations/Movies.csv"))
load(url("http://govfinance.byu.edu/govfinance/classes/dataScience/lectures/illustrations/movies_fitness.RData"))
```

## Movies data frame

### Explore Movies

```{r explore movies}
Movies %>% glimpse()
Movies %>% summary()
```

### Distributions of Type and Rating

```{r distribution of Type and Rating}
Movies %>% count(Type)
Movies %>%
  ggplot(aes(x = Type, fill = Type)) +
  geom_bar(show.legend = FALSE) +
  labs(title = "Distribution of Type")

Movies %>% count(Rating)
Movies %>%
  ggplot(aes(x = Rating, fill = Rating)) +
  geom_bar(show.legend = FALSE) +
  labs(title = "Distribution of Rating")
```

### Time series trends of revenue

```{r time series of trends of revenue, message = FALSE}
Movies %>%
  group_by(Year) %>% 
  summarize(Domestic_median = median(Domestic),
            Worldwide_median = median(Worldwide)) %>% 
  gather(key = Source, value = Revenue, -Year) %>% 
  ggplot(aes(x = Year, y = Revenue, color = Source)) +
  geom_point() +
  geom_smooth(se = FALSE)
```

### Compare Domestic and Worldwide Revenues

```{r domestic and worldwide revenue by rating}
movies <- Movies %>%
  select(Rating, Year, Domestic, Worldwide) %>% 
  gather(key = Source, value = Revenue, -c("Rating", "Year"))

movies %>% ggplot(aes(x = Source, y = Revenue, fill = Source)) +
  geom_boxplot(show.legend = FALSE) + 
  facet_grid(rows = vars(Rating)) +
  coord_flip()
```

### Distributions of revenue by domestic and Rating

```{r distributions of revenue domestic and worldwide revenue by rating}
movies %>% 
  ggplot(aes(x = Rating, y = Revenue, fill = Rating)) +
  geom_boxplot(show.legend = FALSE) + 
  coord_flip() + 
  facet_grid(rows = vars(Source))
```

## Fitness
### Explore Fitness

```{r explore variables in Fitness}
Fitness %>%
  glimpse()
Fitness %>%
  summary()
```

### Comparison of all pulses by sex

```{r boxplot comparison of pulse by sex}
Fitness %>% 
  select(Sex, RunPulse, RstPulse, MaxPulse) %>% 
  gather(key = Pulse_Type, value = Pulse, -Sex) %>% 
  ggplot(aes(x = Sex, y = Pulse, fill = Sex)) +
    geom_boxplot(show.legend = FALSE) +
    facet_grid(rows = vars(Pulse_Type)) +
    coord_flip()
```


### Violin plot of MaxPulse and RunPulse with facet by pulse type
```{r faceting by pulse type}
Fitness %>% 
  select(Sex, RunPulse, MaxPulse) %>% 
  gather(key = Pulse_Type, value = Pulse, -Sex) %>% 
  ggplot(aes(x = Sex, y = Pulse, fill = Sex)) +
    geom_violin(fill = "grey") +
    geom_boxplot(width = 0.25, show.legend = FALSE) +
    facet_grid(rows = vars(Pulse_Type)) +
    coord_flip()
```

### Violin Plot with facet by Sex

```{r faceting with Sex}
Fitness %>% 
  select(Sex, RunPulse, MaxPulse) %>% 
  gather(key = Pulse_Type, value = Pulse, -Sex) %>% 
  ggplot(aes(x = Pulse_Type, y = Pulse, fill = Sex)) +
    geom_violin(fill = "grey") +
    geom_boxplot(width = 0.25, show.legend = FALSE) +
    facet_grid(rows = vars(Sex)) +
    coord_flip()
```

### Relationship of RunPulse and MaxPulse by Gender

```{r relationship of Run and Max Pulse by Gender}
Fitness %>% 
  ggplot(aes(x = RunPulse, y = MaxPulse, color = Sex)) +
    geom_point() +
    geom_smooth(method = "lm", se = FALSE)
```

### Linear Model

```{r linear model}
# Extracting components
regression <- lm(MaxPulse ~ RunPulse, data = Fitness )
regression %>% summary()
regression %>% coef()
```

### Analysis of Residuals

```{r analysis of residuals}
# Plot of Predicted versus actual
plot_data <- tibble(regression$fitted.values, Fitness$MaxPulse, Fitness$Sex)
colnames(plot_data) <- c("Fitted", "Actual", "Sex")

plot_data %>% 
  ggplot(aes(x = Fitted, y = Actual)) +
    geom_point(aes(color = Sex)) +
    geom_smooth(method = "lm", color = "grey")
```

## Example of how time series gathering  

### Load functions for time series calculations

```{r ts manipulation functions}
# Get time series functions
"http://govfinance.byu.edu/govfinance/quantTools/R/manipulations.R" %>%
  url() %>%
  source()
```  

### Get Data from FRED

```{r FRED}
# Time series of income and sales taxes in Utah using from FRED using fImport
revenue <- fredSeries(c("UTSLGRTAX", "UTINCTAX"), from = "1992-01-01") %>%
  as.zoo() %>% 
  pca()
colnames(revenue) <- c("sales", "income")
revenue
```

### Create tibbles and data frames from the FRED data  

```{r create tibbles and data frames from FRED data}
# Extract the date from the zoo object
dates <- revenue %>%
  time() %>%
  as.Date()

# Create a tibble
revenue_tbl <- tibble(dates, as.vector(revenue$sales), as.vector(revenue$income))
colnames(revenue_tbl) <- c("dates", "sales", "income")
revenue_tbl

# Create a data frame
revenue_df <- data.frame(dates, revenue)
colnames(revenue_df) <- c("dates", "sales", "income")
revenue_df
```  

### Time series graphs sales an income taxes by themselves  

```{r sales and income by themselves}
# Graph of sales by itself
revenue_tbl %>% 
  ggplot(aes(x = dates, y = sales)) +
    geom_line() +
    geom_hline(yintercept = 0, color = "red") +
    labs(title = "Utah Sales Tax Growth Rate",
         subtitle = "1992 - 2016",
         x = "",
         y = "Percentage Change")

revenue_tbl %>% 
  ggplot(aes(x = dates, y = income)) +
  geom_line() +
  geom_hline(yintercept = 0, color = "red")  +
  labs(title = "Utah Income Tax Growth Rate",
       subtitle = "1992 - 2016",
       x = "",
       y = "Percentage Change")
```  

### Use graphs to compare sales and income  

```{r gather sales and revenue}  
# Gather the data together
plot_data <- revenue_tbl %>% 
  gather(sales, income, key = "tax", value = "revenue")
```  

```{r comparison of sales and income}
# Time series plot of both in the same graph
plot_data %>% 
  ggplot(aes(x = dates, y = revenue, color = tax)) +
    geom_line() +
    geom_hline(yintercept = 0, color = "red") +
    labs(title = "Utah Sales and Income Tax Growth Rates",
         subtitle = "1992 - 2016",
         x = "",
         y = "Percentage Change")

# Time series plot of each in its own panel
plot_data %>% 
  ggplot(aes(x = dates, y = revenue)) +
    geom_line(aes(color = tax), show.legend = FALSE) +
    facet_grid(rows = vars(tax)) +
    geom_hline(yintercept = 0, color = "red", alpha = 0.25) +
    labs(title = "Utah Sales and Income Tax Growth Rates",
         subtitle = "1992 - 2016",
         x = "",
         y = "Percentage Change")
```  

### Violin plots to compare the distribution of sales and income tax revenues  

```{r violin plot comparison}
# Violin Plot
plot_data %>%
   ggplot(aes(x = tax, y = revenue)) +
    geom_violin(fill = "lightgreen") +
    geom_boxplot(width = 0.25, fill = "lightblue") +
    labs(title = "Comparison of Sales and Income Tax Growth Rates",
         subtitle = "State of Utah, 1992 - 2016",
      x = "Tax",
      y = "Percentage Change") +
    coord_flip()
```  








