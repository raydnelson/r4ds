---
title: "Gathering, Spreading, Separating, and Uniting"
author: "MPA 634: Data Science for Managers"
date: "19 Feb 2020"
output:
  html_document:
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
# Load libraries
library(tidyverse)
library(fImport)
library(zoo)
```

## Import the Data 

### Read from a csv file on a website

```{r file on website}
movies <- read_csv(url("http://govfinance.byu.edu/govfinance/classes/dataScience/lectures/illustrations/movies.csv"))
```

### Read an entire workspace

```{r alternative structures for loading data}
# Load workspace
load(url("http://govfinance.byu.edu/govfinance/classes/dataScience/lectures/illustrations/movies_fitness.RData"))
```  

## Mechanics of gathering with an illustration using Excel

```{r gathering mechanics}
fitness %>% 
  select(name, runpulse:maxpulse) %>% 
  gather(runpulse:maxpulse, key = pulse_type, value = pulse)
```

## Movies

### Explore movies

```{r explore movies}
movies %>%
  summary()
```

### Gathering with all variables

```{r gather all}
movies %>% 
  gather(domestic, worldwide, key = source, value = revenue)
```

### Gathering with a subset of variables

```{r gather subset}
movies %>% 
  select(year, domestic, worldwide) %>% 
  gather(domestic, worldwide, key = source, value = revenue)
```

### Time series trends of revenue

```{r time series of trends of revenue}
movies %>%
  group_by(year) %>% 
  summarize(domestic_median = median(domestic),
            worldwide_median = median(worldwide)) %>% 
  gather(domestic_median, worldwide_median, key = source, value = revenue) %>% 
  ggplot(aes(x = year, y = revenue, color = source)) +
  geom_point() +
  geom_smooth(se = FALSE)
```

### Convert to a long tibble

```{r long movies tibble}
movies_long <- movies %>%
  select(rating, year, domestic, worldwide) %>% 
  gather(domestic:worldwide, key = source, value = revenue)
```

### Compare domestic and worldwide revenues by rating
```{r domestic and worldwide revenue by rating}
movies_long %>%
  ggplot(aes(x = source, y = revenue, fill = source)) +
  geom_boxplot(show.legend = FALSE) + 
  facet_grid(rows = vars(rating)) +
  coord_flip()
```

### Distributions of revenue by domestic by rating

```{r distributions of revenue domestic and worldwide revenue by rating}
movies_long %>% 
  ggplot(aes(x = rating, y = revenue, fill = rating)) +
  geom_boxplot(show.legend = FALSE) + 
  coord_flip() + 
  facet_grid(rows = vars(source))
```

## Fitness
### Explore fitness

```{r explore variables in Fitness}
fitness %>%
  summary()
```

### Comparison of all pulses by sex

```{r boxplot comparison of pulse by sex}
fitness %>% 
  select(sex, runpulse:maxpulse) %>% 
  gather(runpulse:maxpulse, key = pulse_type, value = pulse) %>% 
  ggplot(aes(x = sex, y = pulse, fill = sex)) +
    geom_boxplot(show.legend = FALSE) +
    facet_grid(rows = vars(pulse_type)) +
    coord_flip()
```

### Violin plot of maxpulse and runpulse with facet by pulse type
```{r faceting by pulse type}
fitness %>% 
  select(sex, runpulse, maxpulse) %>% 
  gather(runpulse, maxpulse, key = pulse_type, value = pulse) %>% 
  ggplot(aes(x = sex, y = pulse, fill = sex)) +
    geom_violin(fill = "grey") +
    geom_boxplot(width = 0.25, show.legend = FALSE) +
    facet_grid(rows = vars(pulse_type)) +
    coord_flip()
```

### Violin plot with facet by sex

```{r faceting with Sex}
fitness %>% 
  select(sex, runpulse, maxpulse) %>% 
  gather(runpulse, maxpulse, key = pulse_type, value = pulse) %>% 
  ggplot(aes(x = pulse_type, y = pulse, fill = sex)) +
    geom_violin(fill = "grey") +
    geom_boxplot(width = 0.25, show.legend = FALSE) +
    facet_grid(rows = vars(sex)) +
    coord_flip()
```

### Relationship of runpulse and maxpulse by gender from wide tibble

```{r relationship of Run and Max Pulse by Gender}
fitness %>% 
  ggplot(aes(x = runpulse, y = maxpulse, color = sex)) +
    geom_point() +
    geom_smooth(method = "lm", se = FALSE)
```

### Linear Model

```{r linear model}
# Extracting components
regression <- lm(maxpulse ~ runpulse, data = fitness )
regression %>%
  summary()
regression %>%
  coef()
```

### Analysis of residuals

```{r analysis of residuals}
# Plot of Predicted versus actual
plot_data <- tibble(regression$fitted.values, fitness$maxpulse, fitness$sex)
colnames(plot_data) <- c("fitted", "actual", "sex")

plot_data %>% 
  ggplot(aes(x = fitted, y = actual)) +
    geom_point(aes(color = sex)) +
    geom_smooth(method = "lm", color = "grey")
```

## Example of how time series gathering  

### Get time series functions, get Data from FRED, and create a data frame

```{r FRED}
# Get time series functions
"http://govfinance.byu.edu/govfinance/quantTools/R/manipulations.R" %>%
  url() %>%
  source()
# Time series of income and sales taxes in Utah using from FRED using fImport
revenue <- fredSeries(c("UTSLGRTAX", "UTINCTAX"), from = "1992-01-01") %>%
  as.zoo() %>% 
  pca()
colnames(revenue) <- c("sales", "income")

# Get the dates variable
dates <- revenue %>%
  time() %>%
  as.Date()

# Create a data frame
revenue <- data.frame(dates, revenue)
colnames(revenue) <- c("dates", "sales", "income")
```

### Violin plots to compare the distribution of sales and income tax revenues  

```{r violin plot comparison}
# Violin Plot
revenue %>%
  gather(sales, income, key = "tax", value = "revenue") %>%
  ggplot(aes(x = tax, y = revenue)) +
  geom_violin(fill = "lightgreen") +
  geom_boxplot(width = 0.25, fill = "lightblue") +
  labs(
    title = "Comparison of Sales and Income Tax Growth Rates",
    subtitle = "State of Utah, 1992 - 2016",
    x = "Tax",
    y = "Percentage Change"
  ) +
  coord_flip()
```  








