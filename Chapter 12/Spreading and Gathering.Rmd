---
title: "Pivoting (long and wide), Separating, and Uniting"
author: "MPA 634: Data Science for Managers"
date: "25 Feb 2021"
output:
  html_document:
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
# Load libraries
library(tidyverse)
library(fImport)
library(zoo)
```

## Import the Data

### Read from a csv file on a website

```{r file on website}
movies <- read_csv(url("http://govfinance.byu.edu/govfinance/classes/dataScience/lectures/illustrations/movies.csv"))
```

### Read an entire workspace

```{r alternative structures for loading data}
# Load workspace
load(url("http://govfinance.byu.edu/govfinance/classes/dataScience/lectures/illustrations/movies_fitness.RData"))
```

## Mechanics of gathering with an illustration using Excel

```{r gathering mechanics}
fitness %>%
  select(name, runpulse:maxpulse) %>%
  pivot_longer(runpulse:maxpulse,
               names_to = "pulse_type",
               values_to = "pulse")
```

## Movies

### Explore movies

```{r explore movies}
movies %>%
  summary()
```

### Gathering with all variables

```{r gather all}
movies %>%
  pivot_longer(c("domestic", "worldwide"),
               names_to = "source",
               values_to = "revenue")
```

### Gathering with a subset of variables

```{r gather subset}
movies %>% 
  select(year, domestic, worldwide) %>% 
  gather(!year, key = source, value = revenue)
```

### Time series trends of revenue

```{r time series of trends of revenue}
movies %>%
  group_by(year) %>%
  summarize(domestic_median = median(domestic),
            worldwide_median = median(worldwide)) %>%
  pivot_longer(!year, names_to = "source", values_to  = "revenue") %>%
  ggplot(aes(x = year, y = revenue, color = source)) +
  geom_point() +
  geom_smooth(se = FALSE)
```

### Convert to a long tibble

```{r long movies tibble}
movies_long <- movies %>%
  select(rating, year, domestic, worldwide) %>% 
  pivot_longer(domestic:worldwide, names_to  = "source", values_to = "revenue")
```

### Compare domestic and worldwide revenues by rating

```{r domestic and worldwide revenue by rating}
movies_long %>%
  ggplot(aes(x = revenue, y = source)) +
  geom_boxplot(fill = "lightblue", alpha = 0.5) +
  stat_summary(
    fun = "mean",
    geom = "point",
    shape = 23,
    size = 1.5,
    fill = "red"
  ) +
  facet_grid(rows = vars(rating)) 
```

### Distributions of revenue by domestic by rating

```{r distributions of revenue domestic and worldwide revenue by rating}
movies_long %>%
  ggplot(aes(y = rating, x = revenue, fill = rating)) +
  geom_boxplot(show.legend = FALSE) +
  stat_summary(
    fun = "mean",
    geom = "point",
    shape = 23,
    size = 1.5,
    fill = "red"
  ) +
  facet_grid(rows = vars(source))
```

## Fitness

### Explore fitness

```{r explore variables in fitness}
fitness %>%
  summary()
```

### Comparison of all pulses by sex

```{r boxplot comparison of pulse by sex}
fitness %>%
  select(sex, runpulse:maxpulse) %>%
  pivot_longer(!sex,
               names_to = "pulse_type",
               values_to = "pulse") %>%
  ggplot(aes(y = sex, x = pulse, fill = sex)) +
  geom_boxplot(show.legend = FALSE) +
  stat_summary(
    fun = "mean",
    geom = "point",
    shape = 23,
    size = 1.5,
    fill = "red"
  ) +
  facet_grid(rows = vars(pulse_type))
```

### Violin plot of maxpulse and runpulse with facet by pulse type

```{r faceting by pulse type}
fitness %>%
  select(sex, runpulse, maxpulse) %>%
  pivot_longer(!sex,
               names_to = "pulse_type",
               values_to = "pulse") %>%
  ggplot(aes(x = pulse, y = pulse_type)) +
  geom_violin(fill = "lightblue", alpha = 0.5) +
  geom_boxplot(width = 0.10, fill = "grey60") +
  stat_summary(
    fun = "mean",
    geom = "point",
    shape = 23,
    size = 1.5,
    fill = "red"
  ) +
  facet_grid(rows = vars(pulse_type))
```

### Violin plot with facet by sex

```{r faceting with Sex}
fitness %>% 
  select(sex, runpulse, maxpulse) %>% 
  pivot_longer(!sex,
               names_to = "pulse_type",
               values_to = "pulse") %>%
    ggplot(aes(x = pulse, y = pulse_type)) +
    geom_violin(fill = "lightblue", alpha = 0.5) +
    geom_boxplot(width = 0.10, fill = "grey60") +
    stat_summary(fun = "mean",
      geom = "point",
      shape = 23,
      size = 1.5,
      fill = "red") +
    facet_grid(rows = vars(sex))
```

Tidy tibble example using the who tibble

```{r}
who
```


```{r pivot longer}
who1 <- who %>% 
  pivot_longer(
    cols = new_sp_m014:newrel_f65, 
    names_to = "key", 
    values_to = "cases", 
    values_drop_na = TRUE
  )
```

count key

```{r}
who1 %>% 
  count(key)
```

The first three letters of each column denote whether the column contains new or old cases of TB. In this dataset, each column contains new cases.

The next two letters describe the type of TB:

rel stands for cases of relapse
ep stands for cases of extrapulmonary TB
sn stands for cases of pulmonary TB that could not be diagnosed by a pulmonary smear (smear negative)
sp stands for cases of pulmonary TB that could be diagnosed by a pulmonary smear (smear positive)
The sixth letter gives the sex of TB patients. The dataset groups cases by males (m) and females (f).

The remaining numbers gives the age group. The dataset groups cases into seven age groups:

014 = 0 – 14 years old
1524 = 15 – 24 years old
2534 = 25 – 34 years old
3544 = 35 – 44 years old
4554 = 45 – 54 years old
5564 = 55 – 64 years old
65 = 65 or older

